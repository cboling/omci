/*
 * Copyright (c) 2018 - present.  Boling Consulting Solutions (bcsw.net)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 * NOTE: This file was generated, manual edits will be overwritten!
 *
 * Generated by 'goCodeGenerator.py':
 *              https://github.com/cboling/OMCI-parser/README.md
 */
package generated

import (
	"errors"
	"fmt"
	"github.com/deckarep/golang-set"
	"github.com/google/gopacket"
)

type ManagedEntity struct {
	Definition *ManagedEntityDefinition
	Attributes AttributeValueMap
}

// String provides a simple string that describes this struct
func (entity *ManagedEntity) String() string {
	return fmt.Sprintf("ManagedEntity: (%v) %v/%v (%#x/%#x): Attributes: %v",
		entity.GetName, entity.GetClassID(), entity.GetEntityID(),
		entity.GetClassID(), entity.GetEntityID(), entity.Attributes)
}

func (entity *ManagedEntity) GetName() string {
	return entity.Definition.GetName()
}

func (entity *ManagedEntity) GetClassID() uint16 {
	return entity.Definition.GetClassID()
}

func (entity *ManagedEntity) GetMessageTypes() mapset.Set {
	return entity.Definition.GetMessageTypes()
}

func (entity *ManagedEntity) GetAllowedAttributeMask() uint16 {
	return entity.Definition.GetAllowedAttributeMask()
}

func (entity *ManagedEntity) GetAttributeDefinitions() *AttributeDefinitionMap {
	return entity.Definition.GetAttributeDefinitions()
}

func (entity *ManagedEntity) DecodeAttributes(mask uint16, data []byte, p gopacket.PacketBuilder) (AttributeValueMap, error) {
	return entity.Definition.DecodeAttributes(mask, data, p)
}

func (entity *ManagedEntity) SerializeAttributes(attr AttributeValueMap, mask uint16, b gopacket.SerializeBuffer) error {
	return entity.Definition.SerializeAttributes(attr, mask, b)
}

func (entity *ManagedEntity) GetEntityID() uint16 {
	if eid, err := entity.GetAttributeByIndex(0); err == nil {
		return eid.(uint16)
	}
	return 0
}

func (entity *ManagedEntity) SetEntityID(eid uint16) error {
	return entity.SetAttributeByIndex(0, eid)
}

func (entity *ManagedEntity) GetAttributeValueMap() *AttributeValueMap {
	return &entity.Attributes
}

func (entity *ManagedEntity) GetAttribute(name string) (interface{}, error) {
	value, ok := entity.Attributes[name]
	if !ok {
		return 0, errors.New(fmt.Sprintf("attribute '%v' not found", name))
	}
	return value, nil
}

func (entity *ManagedEntity) GetAttributeByIndex(index uint) (interface{}, error) {
	if len(entity.Attributes) == 0 {
		return nil, errors.New("attributes have already been set")
	}
	if _, ok := entity.Definition.AttributeDefinitions[index]; !ok {
		return nil, errors.New(fmt.Sprintf("invalid attribute index: %d, should be 0..%d",
			index, len(entity.Definition.AttributeDefinitions)-1))
	}
	return entity.GetAttribute(entity.Definition.AttributeDefinitions[index].Name)
}

func (entity *ManagedEntity) setAttributes(params ...ParamData) error {
	if len(entity.Attributes) > 0 {
		return errors.New("attributes have already been set")
	}
	eidName := entity.Definition.AttributeDefinitions[0].Name
	if len(params) == 0 {
		entity.Attributes[eidName] = 0
		return nil
	}
	entity.Attributes[eidName] = params[0].EntityID

	for name, value := range params[0].Attributes {
		if name == eidName {
			continue
		}
		if err := entity.SetAttribute(name, value); err != nil {
			return err
		}
	}
	return nil
}

func (entity *ManagedEntity) SetAttribute(name string, value interface{}) error {
	_, err := GetAttributeDefinitionByName(entity.Definition.GetAttributeDefinitions(), name)
	if err != nil {
		return err
	}
	// TODO: check type and any constraints
	entity.Attributes[name] = value
	return nil
}

func (entity *ManagedEntity) SetAttributeByIndex(index uint, value interface{}) error {
	attrDef, ok := entity.Definition.AttributeDefinitions[index]
	if !ok {
		return errors.New(fmt.Sprintf("invalid attribute index: %d, should be 0..%d",
			index, len(entity.Definition.AttributeDefinitions)-1))
	}
	// TODO: Check type and any constraints
	entity.Attributes[attrDef.Name] = value
	return nil
}
